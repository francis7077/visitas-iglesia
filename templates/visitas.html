{% extends "base.html" %}
{% block contenido %}

<h1 class="titulo-visitas">üìã Gesti√≥n de Seguimiento</h1>

{% if session.get("expirada") %}
<div class="alerta alerta-roja">
    ‚è±Ô∏è Tu sesi√≥n expir√≥ por inactividad. Por seguridad, inicia sesi√≥n nuevamente.
</div>
{% endif %}

<div style="display:grid; grid-template-columns:repeat(3,1fr); gap:15px; margin-bottom:25px;">
    <div class="tarjeta-perfil" style="text-align:center; border-top: 4px solid #3b82f6;">
        <div style="font-size:24px; font-weight:bold;">{{ total }}</div>
        <div style="font-size:12px; color:#666; text-transform:uppercase;">Registros en per√≠odo</div>
    </div>
    <div class="tarjeta-perfil" style="text-align:center; border-top: 4px solid #22c55e;">
        <div style="font-size:24px; font-weight:bold; color:#16a34a;">{{ visitados }}</div>
        <div style="font-size:12px; color:#666; text-transform:uppercase;">Personas Visitadas</div>
    </div>
    <div class="tarjeta-perfil" style="text-align:center; border-top: 4px solid #f59e0b;">
        <div style="font-size:24px; font-weight:bold; color:#d97706;">{{ pendientes }}</div>
        <div style="font-size:12px; color:#666; text-transform:uppercase;">Pendientes de Visita</div>
    </div>
</div>

<form method="get" class="filtros filtros-card">
    <div class="filtro-grupo">
        <label>Fecha Inicial</label>
        <input type="date" name="desde" value="{{ desde }}">
    </div>

    <div class="filtro-grupo">
        <label>Fecha Final</label>
        <input type="date" name="hasta" value="{{ hasta }}">
    </div>

    <div class="filtro-grupo filtro-boton">
        <button type="submit">üîç Filtrar Datos</button>
        {% if desde or hasta %}
            <a href="/visitas" class="link-limpiar">Limpiar Filtros</a>
        {% endif %}
    </div>
</form>

<div class="acciones acciones-fijas">
    <button id="btnImprimir" class="btn-accion" title="Filtre un rango de fechas para imprimir" {{ 'disabled' if not (desde and hasta) }}>
        üñ®Ô∏è Reporte PDF
    </button>
    <button id="btnEditar" class="btn-accion" disabled>‚úèÔ∏è Editar</button>
    <button id="btnEliminar" class="btn-accion" disabled>üóëÔ∏è Eliminar</button>
</div>

<div class="tabla-contenedor">
<table id="tablaVisitas">
    <thead>
        <tr>
            <th>Fecha Registro</th>
            <th>Nombre Completo</th>
            <th>Invitado por</th>
            <th>Estado</th>
            <th>Esfuerzo Visita</th>
        </tr>
    </thead>

    <tbody>
    {% for r in visitas %}
        <tr data-id="{{ r['id'] }}" onclick="seleccionarFila(this)">
            
            <td class="col-fecha">
                {{ r['fecha'] | formato_fecha }}
            </td>

            <td class="col-nombre">
                <a href="/perfil/{{ r['id'] }}" onclick="event.stopPropagation()">
                    <strong>{{ r['nombre'] }}</strong>
                </a>
            </td>

            <td class="col-invitado">{{ r['invitado_por'] or "Espont√°neo" }}</td>

            <td class="col-estado">
                {% if r['visitado'] == 'Si' %}
                    <span class="badge ok">‚úî COMPLETADO</span>
                {% else %}
                    <span class="badge no">‚è≥ PENDIENTE</span><br>
                    <a href="/visitar/{{ r['id'] }}" class="link-marcar" onclick="event.stopPropagation()">
                        Realizar Visita
                    </a>
                {% endif %}
            </td>

            <td class="col-detalle">
                <a href="/visitar/{{ r['id'] }}" class="btn-historial" onclick="event.stopPropagation()">
                    {% if r['total_visitas'] > 0 %}
                        üìÑ {{ r['total_visitas'] }} seguimiento(s)
                    {% else %}
                        <span style="color:#999;">Sin visitas</span>
                    {% endif %}
                </a>
            </td>

        </tr>
    {% else %}
        <tr>
            <td colspan="5" class="vacio">
                No se encontraron registros para los filtros seleccionados.
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
</div>

<a href="/" class="btn-volver">‚Üê Registrar Nueva Persona</a>

<script>
let idSeleccionado = null;

function seleccionarFila(fila) {
    // Limpiar selecci√≥n previa
    document.querySelectorAll("#tablaVisitas tbody tr").forEach(tr => {
        tr.classList.remove("fila-activa");
    });

    // Marcar nueva selecci√≥n
    fila.classList.add("fila-activa");
    idSeleccionado = fila.dataset.id;

    // Habilitar botones de acci√≥n
    document.getElementById("btnEditar").disabled = false;
    document.getElementById("btnEliminar").disabled = false;
}

// L√≥gica de navegaci√≥n
document.getElementById("btnEditar").onclick = function () {
    if (idSeleccionado) window.location.href = "/editar/" + idSeleccionado;
};

document.getElementById("btnEliminar").onclick = function () {
    if (idSeleccionado && confirm("¬øEst√° seguro de eliminar este registro? Esto borrar√° tambi√©n su historial de visitas.")) {
        window.location.href = "/eliminar/" + idSeleccionado;
    }
};

// Imprimir reporte filtrado
document.getElementById("btnImprimir").onclick = function () {
    const d = "{{ desde }}";
    const h = "{{ hasta }}";
    if (d && h) {
        window.open(`/imprimir?desde=${d}&hasta=${h}`, "_blank");
    }
};
</script>

<style>
    /* Valor agregado: Estilos para mejorar la experiencia de usuario */
    .fila-activa { background-color: #e0f2fe !important; border-left: 4px solid #0284c7; }
    .btn-accion:disabled { opacity: 0.5; cursor: not-allowed; }
    .link-limpiar { color: #ef4444; font-size: 0.8em; margin-left: 10px; text-decoration: none; }
    .link-marcar { font-size: 0.85em; color: #2563eb; font-weight: bold; }
    .btn-historial { text-decoration: none; color: #4b5563; font-size: 0.9em; }
    .btn-historial:hover { color: #000; }
</style>

{% endblock %}