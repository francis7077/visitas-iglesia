{% extends "base.html" %}
{% block contenido %}

<div class="header-visitas">
    <h1 class="titulo-visitas" style="margin: 0;">ğŸ“‹ Panel de Seguimiento</h1>
    <div class="fecha-hoy">
        ğŸ“… Hoy: {{ ahora.strftime('%d/%m/%Y') }}
    </div>
</div>

{% if session.get("expirada") %}
<div class="alerta alerta-roja" style="border-radius: 12px; animation: shake 0.5s ease;">
    â±ï¸ Tu sesiÃ³n expirÃ³ por inactividad. Por seguridad, inicia sesiÃ³n nuevamente.
</div>
{% endif %}

<div class="stats-grid">
    <div class="tarjeta-perfil stat-card azul">
        <div class="stat-num">{{ total }}</div>
        <div class="stat-label">Registros Totales</div>
    </div>

    <div class="tarjeta-perfil stat-card verde">
        <div class="stat-num">{{ visitados }}</div>
        <div class="stat-label">Seguimientos Listos</div>
    </div>

    <div class="tarjeta-perfil stat-card naranja">
        <div class="stat-num">{{ pendientes }}</div>
        <div class="stat-label">Pendientes por Visitar</div>
    </div>
</div>

<form method="get" class="filtros-card">
    <div class="filtros-grid">
        <div class="filtro-grupo">
            <label>Desde</label>
            <input type="date" name="desde" value="{{ desde }}">
        </div>

        <div class="filtro-grupo">
            <label>Hasta</label>
            <input type="date" name="hasta" value="{{ hasta }}">
        </div>

        <div class="filtro-botones">
            <button type="submit" class="btn-filtrar">ğŸ” Filtrar</button>
            {% if desde or hasta %}
            <a href="/visitas" class="btn-limpiar">ğŸ§¹</a>
            {% endif %}
        </div>
    </div>
</form>

<div class="toolbar-acciones">
        <button id="btnImprimir" class="btn-mini-accion" {{ 'disabled' if not (desde and hasta) }}>
            ğŸ–¨ï¸ PDF
        </button>
        <button id="btnEditar" class="btn-mini-accion btn-edit" disabled>
            âœï¸ Editar
        </button>
        <button id="btnEliminar" class="btn-mini-accion btn-delete" disabled>
            ğŸ—‘ï¸ Eliminar
        </button>
    </div>
</div>

<div class="tabla-contenedor">
<table id="tablaVisitas">
    <thead>
        <tr>
            <th>ğŸ“… Registro</th>
            <th>ğŸ‘¤ Visitante</th>
            <th>ğŸ¤ Invitado</th>
            <th>ğŸ“ Estado</th>
            <th>ğŸ“‹ Seguimientos</th>
        </tr>
    </thead>

    <tbody>
    {% for r in visitas %}
        <tr data-id="{{ r['id'] }}" onclick="seleccionarFila(this)">
            <td class="col-fecha">{{ r['fecha'] | formato_fecha }}</td>
            <td class="col-nombre">
                <a href="/perfil/{{ r['id'] }}" onclick="event.stopPropagation()">{{ r['nombre'] }}</a>
            </td>
            <td class="col-invitado">{{ r['invitado_por'] or "EspontÃ¡neo" }}</td>
            <td class="col-estado">
                {% if r['visitado'] == 'Si' %}
                    <span class="badge ok">âœ” LISTO</span>
                {% else %}
                    <span class="badge no">â³ PENDIENTE</span>
                {% endif %}
            </td>
            <td class="col-detalle">
                <a href="/visitar/{{ r['id'] }}" onclick="event.stopPropagation()">
                    {% if r['total_visitas'] > 0 %}
                        <span class="count-pill">{{ r['total_visitas'] }}</span> Reportes
                    {% else %}Agregar visita{% endif %}
                </a>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
</div>

<div class="footer-nav">
    <a href="/" class="btn-nuevo-app">
        <span>+</span> Registrar Nueva Persona
    </a>
</div>

<script>
let idSeleccionado = null;
function seleccionarFila(fila){
    document.querySelectorAll("#tablaVisitas tbody tr").forEach(tr=>tr.classList.remove("fila-activa"));
    fila.classList.add("fila-activa");
    idSeleccionado = fila.dataset.id;
    document.getElementById("btnEditar").disabled=false;
    document.getElementById("btnEliminar").disabled=false;
}
document.getElementById("btnEditar").onclick=()=>idSeleccionado && (location.href="/editar/"+idSeleccionado);
document.getElementById("btnEliminar").onclick=()=>idSeleccionado && confirm("Â¿Eliminar registro?") && (location.href="/eliminar/"+idSeleccionado);
document.getElementById("btnImprimir").onclick=()=>window.open(`/imprimir?desde={{ desde }}&hasta={{ hasta }}`);
</script>

<style>
.header-visitas{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:20px}
.fecha-hoy{background:white;padding:6px 14px;border-radius:20px;font-size:12px}

.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:25px}
.stat-card{padding:15px;border-radius:15px;text-align:center}
.azul{border-top:4px solid #3b82f6}.verde{border-top:4px solid #22c55e}.naranja{border-top:4px solid #f59e0b}
.stat-num{font-size:26px;font-weight:800}
.stat-label{font-size:11px;text-transform:uppercase;color:#64748b}

.filtros-card{background:white;padding:15px;border-radius:15px;margin-bottom:20px}
.filtros-grid{display:flex;flex-wrap:wrap;gap:15px}
.filtro-grupo{flex:1;min-width:150px}
.filtro-botones{display:flex;gap:10px}

.tabla-contenedor{overflow-x:auto;background:white;border-radius:15px}
#tablaVisitas{min-width:720px;width:100%}
.fila-activa{background:#e0f2fe}

@media(max-width:768px){
    .stats-grid{grid-template-columns:1fr 1fr}
    .filtros-grid{flex-direction:column}
}
</style>

{% endblock %}
