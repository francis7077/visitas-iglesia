{% extends "base.html" %}
{% block contenido %}

<h1 class="titulo-visitas">ğŸ“‹ Visitas Registradas</h1>

<!-- ğŸ” Mensaje si la sesiÃ³n expirÃ³ -->
{% if session.get("expirada") %}
<div class="alerta alerta-roja">
    â±ï¸ Tu sesiÃ³n expirÃ³ por inactividad. Inicia sesiÃ³n nuevamente.
</div>
{% endif %}

<!-- ğŸ” Barra de filtros -->
<form method="get" class="filtros filtros-card">
    <div class="filtro-grupo">
        <label>Desde</label>
        <input type="date" name="desde" value="{{ desde }}">
    </div>

    <div class="filtro-grupo">
        <label>Hasta</label>
        <input type="date" name="hasta" value="{{ hasta }}">
    </div>

    <div class="filtro-grupo filtro-boton">
        <button type="submit">ğŸ” Filtrar</button>
    </div>
</form>

<!-- ğŸ“Š Indicadores rÃ¡pidos -->
{% if visitas %}
<div class="resumen-visitas">
    <span>ğŸ‘¥ Total: <strong>{{ visitas|length }}</strong></span>
    <span>ğŸŸ¢ Visitados: 
        <strong>
        {{ visitas | selectattr("visitado","equalto","Si") | list | length }}
        </strong>
    </span>
    <span>â³ Pendientes: 
        <strong>
        {{ visitas | selectattr("visitado","equalto","No") | list | length }}
        </strong>
    </span>
</div>
{% endif %}

<!-- âš™ï¸ Acciones -->
<div class="acciones acciones-fijas">
    <button id="btnImprimir" disabled>ğŸ–¨ï¸ Imprimir</button>
    <button id="btnEditar" disabled>âœï¸ Editar</button>
    <button id="btnEliminar" disabled>ğŸ—‘ï¸ Eliminar</button>
</div>

<!-- ğŸ“‹ Tabla -->
<div class="tabla-contenedor">
<table id="tablaVisitas">
    <thead>
        <tr>
            <th>Fecha</th>
            <th>Nombre</th>
            <th>Invitado por</th>
            <th>Estado</th>
            <th>Detalle</th>
        </tr>
    </thead>

    <tbody>
    {% for r in visitas %}
        <tr data-id="{{ r['id'] }}" onclick="seleccionarFila(this)" tabindex="0">

            <td class="col-fecha">
                {{ r['fecha'].strftime('%d/%m/%Y') }}
            </td>

            <td class="col-nombre">
                <a href="/perfil/{{ r['id'] }}" onclick="event.stopPropagation()">
                    <strong>{{ r['nombre'] }}</strong>
                </a>
            </td>

            <td class="col-invitado">{{ r['invitado_por'] or "â€”" }}</td>

            <td class="col-estado">
                {% if r['visitado'] == 'Si' %}
                    <span class="badge ok">âœ” Visitado</span>
                {% else %}
                    <span class="badge no">â³ Pendiente</span><br>
                    <a href="/visitar/{{ r['id'] }}" class="link-pequeÃ±o" onclick="event.stopPropagation()">
                        Marcar
                    </a>
                {% endif %}
            </td>

            <td class="col-detalle">
                {% if r['visitado'] == 'Si' %}
                    <a href="/visitar/{{ r['id'] }}" onclick="event.stopPropagation()">ğŸ“„ Ver</a>
                {% else %}
                    â€”
                {% endif %}
            </td>

        </tr>
    {% else %}
        <tr>
            <td colspan="5" class="vacio">
                No hay visitas registradas en este perÃ­odo
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
</div>

<a href="/" class="btn-volver">â† Volver al registro</a>

<script>
let idSeleccionado = null;

function seleccionarFila(fila) {
    document.querySelectorAll("#tablaVisitas tbody tr").forEach(tr => {
        tr.classList.remove("fila-activa");
    });

    fila.classList.add("fila-activa");
    idSeleccionado = fila.dataset.id;

    document.getElementById("btnEditar").disabled = false;
    document.getElementById("btnEliminar").disabled = false;
}

// Permitir seleccionar con Enter (accesibilidad)
document.querySelectorAll("#tablaVisitas tbody tr").forEach(row => {
    row.addEventListener("keydown", e => {
        if (e.key === "Enter") seleccionarFila(row);
    });
});

// Editar
document.getElementById("btnEditar").onclick = function () {
    if (idSeleccionado) {
        window.location.href = "/editar/" + idSeleccionado;
    }
};

// Eliminar
document.getElementById("btnEliminar").onclick = function () {
    if (idSeleccionado && confirm("Â¿Desea eliminar este registro?")) {
        window.location.href = "/eliminar/" + idSeleccionado;
    }
};

// Imprimir
const desde = "{{ desde }}";
const hasta = "{{ hasta }}";
const btnImprimir = document.getElementById("btnImprimir");

if (desde && hasta) {
    btnImprimir.disabled = false;
}

btnImprimir.onclick = function () {
    if (desde && hasta) {
        window.open(`/imprimir?desde=${desde}&hasta=${hasta}`, "_blank");
    }
};
</script>

{% endblock %}
